Como o Open Food Facts usa logotipos para obter informa√ß√µes sobre produtos aliment√≠cios

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3><strong>üßÇUma pitada de contexto:</strong> ‚Äúlogos‚Äù ?</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>O Open Food Facts cont√©m cerca de <strong>3 milh√µes de produtos</strong>. Cada produto tem uma embalagem feita para atrair o maior n√∫mero de pessoas poss√≠vel. Nesse sentido, os produtores destacam as qualidades de seus produtos com<strong> s√≠mbolos chamativos e expl√≠citos</strong>. Esses s√≠mbolos s√£o numerosos e podem dar informa√ß√µes sobre a marca do produto, sua qualidade, sua composi√ß√£o, como foi feito, em qual caixa descart√°-lo, etc‚Ä¶&nbsp;</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Para homogeneizar todos os s√≠mbolos e ajudar os consumidores a encontrar produtos que se encaixem neles, <strong>v√°rias institui√ß√µes criaram regras r√≠gidas para que os produtores possam marcar seus produtos com s√≠mbolos espec√≠ficos que chamamos ‚Äúlogotipos‚Äù</strong>. Portanto, h√° uma grande oportunidade üî• de obter dados sobre produtos detectando esses logotipos!</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><strong>Como o Open Food Facts deve detect√°-los? Gra√ßas a uma mistura entre tecnologia e colaboradores, como sempre!</strong></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Rapha√´l Bournhonesque, um antigo colaborador do Open Food Facts que agora faz parte da equipe permanente e meu supervisor de est√°gio, desenvolveu no Robotoff* <strong>um sistema para extrair logotipos de imagens, convert√™-los em vetores e encontrar os vizinhos mais pr√≥ximos de cada vetor.</strong> O objetivo de encontrar os vizinhos dos logotipos era <strong>permitir que os colaboradores "anotassem" (categorizassem manualmente) grandes quantidades de logotipos ao mesmo tempo por meio de uma plataforma chamada <a rel="noreferrer noopener" href="https://hunger.openfoodfacts.org/" target="_blank">Jogos Vorazes</a> </strong>üòâ.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Entretanto, os modelos e algoritmos usados naquela √©poca n√£o conseguiam fornecer resultados suficientemente eficientes.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Em setembro de 2022, eu, estudante de engenharia, entrei para a equipe em um est√°gio de 6 meses que se dedicaria a logotipos, e trabalhei na refatora√ß√£o de todo esse processo! &nbsp;</p>
<!-- /wp:paragraph -->

<!-- wp:table -->
<figure class="wp-block-table"><table><tbody><tr><td><strong>* What is Robotoff ?</strong><br><a rel="noreferrer noopener" href="https://github.com/openfoodfacts/robotoff" target="_blank">Robotoff</a> is a service developed by contributors to help Open Food Facts data processing. Com base nas informa√ß√µes j√° dispon√≠veis no banco de dados, o objetivo √© recuperar o m√°ximo de informa√ß√µes poss√≠vel sobre cada produto e adicion√°-los ao banco de dados. Atualmente, as atualiza√ß√µes feitas pelo Robotoff v√™m da an√°lise de imagens, atrav√©s de Reconhecimento √ìptico de Caracteres ou modelos mais gerais de Vis√£o Computacional. Algumas atualiza√ß√µes s√£o aplicadas automaticamente ao banco de dados, mas outras precisam de valida√ß√£o manual atrav√©s de perguntas ou pelo programa Hunger Games.<br><br><em><strong>Para saber mais sobre Robotoff, d√™ uma olhada <a rel="noreferrer noopener" href="https://github.com/openfoodfacts/robotoff#readme" target="_blank">aqui</a>!</strong></em>üëÄ</td></tr></tbody></table></figure>
<!-- /wp:table -->

<!-- wp:heading {"level":3} -->
<h3><strong>ü´ó Um pouco de tecnologia: </strong>Como funciona exatamente o processamento de logotipos?</h3>
<!-- /wp:heading -->

<!-- wp:heading {"level":4} -->
<h4><em>1Ô∏è‚É£ </em>Extraia logotipos de imagens de produtos:</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Os colaboradores do Open Food Facts treinaram um modelo de aprendizado de m√°quina para reconhecer logotipos em imagens. Colocamos uma imagem como entrada do modelo e recebemos v√°rias caixas delimitadoras com pontua√ß√µes e classes correspondentes. As classes nas quais o modelo foi treinado foram ‚Äúmarca‚Äù e ‚Äúr√≥tulo‚Äù.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Voc√™ pode encontrar o c√≥digo onde o modelo √© chamado aqui: <a href="https://github.com/openfoodfacts/robotoff/blob/b209707cc062310b51f9886c87ee14be91527644/robotoff/workers/tasks/import_image.py#L325" target="_blank" rel="noreferrer noopener">Robotoff.import_image.py</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Voc√™ pode tentar usando a seguinte API:&nbsp;<a href="https://robotoff.openfoodfacts.net/api/v1/images/predict?image_url=[image_url]&amp;models=universal-logo-detector" target="_blank" rel="noreferrer noopener">https://robotoff.openfoodfacts.net/api/v1/images/predict?image_url=[image_url]&amp;models=universal-logo-detector</a></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Com as caixas delimitadoras, voc√™ pode ver quais s√£o os logotipos correspondentes com a API: <a href="https://robotoff.openfoodfacts.net/api/v1/images/crop?image_url=[image_url]&amp;y_min=[y_min]&amp;x_min=[x_min]&amp;y_max=[y_max]&amp;x_max=[x_max]" target="_blank" rel="noreferrer noopener">https://robotoff.openfoodfacts.net/api/v1/images/crop?image_url=[image_url]&amp;y_min=[y_min]&amp;x_min=[x_min]&amp;y_max=[y_max]&amp;x_max=[x_max]</a> onde as coordenadas est√£o na mesma ordem que as retornadas pelo modelo nas caixas delimitadoras.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Aqui est√° um exemplo do que acontece ao usar essas APIs com a seguinte imagem:</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><a href="https://images.openfoodfacts.org/images/products/322/982/012/9488/front_fr.194.400.jpg" target="_blank" rel="noreferrer noopener">https://images.openfoodfacts.org/images/products/322/982/012/9488/front_fr.194.400.jpg</a></p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":3425,"width":806,"height":252,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large is-resized"><img src="https://blog.openfoodfacts.org/wp-content/uploads/2023/02/Screenshot-2023-02-14-at-14.34.51-1024x321.png" alt="" class="wp-image-3425" width="806" height="252"/></figure>
<!-- /wp:image -->

<!-- wp:heading {"level":4} -->
<h4><em>2Ô∏è‚É£ </em>Converter imagens de logotipos em vetores:</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><strong>Agora que podemos acessar os logotipos, precisamos vetoriz√°-los</strong>. Para isso, usamos um modelo pr√©-treinado do OpenAI chamado <a href="https://huggingface.co/docs/transformers/model_doc/clip" target="_blank" rel="noreferrer noopener">CLIP</a>. Even though the model was initially trained to match images with text, we use only the ‚Äúcomputer vision‚Äù part of the model to get the embeddings (=logos embedded in a vector space) computed by CLIP for each logo.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>We thus have a logo image as input and a vector of dimension 512 as output. The smaller the distance between two vectors is, the more similar the two corresponding logos are.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>The <a href="https://github.com/openfoodfacts/robotoff/blob/b209707cc062310b51f9886c87ee14be91527644/robotoff/workers/tasks/import_image.py#L398" target="_blank" rel="noreferrer noopener">save_logo_embeddings</a> function in Robotoff is in charge of applying the model to logos and save embeddings to the Robotoff postgresql database.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>You can find a more explicit code <a href="https://github.com/openfoodfacts/openfoodfacts-ai/blob/develop/logo-ann/generation/02_generate_embeddings.py#L108" target="_blank" rel="noreferrer noopener">here</a> to understand how we use CLIP to generate logos embeddings.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4><em>3Ô∏è‚É£ </em>Find nearest neighbours:</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>To find the nearest neighbors of a logo, we use an ‚Äúindex‚Äù to store the embeddings. Once this index is built, we could use the <strong>‚Äúbrute force‚Äù üí™ method which consists in computing the distance between the query logo and all the other logos of the db and return the closest ones</strong>. That‚Äôs the most precise method as it gives us the ‚Äútrue‚Äù nearest neighbors. However, this method is too slow to be applied. The time needed to extract the nearest neighbors for each logo when the total amount of logos is 2.5M is around 3s üò¥</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>As we needed a better search time and were ok with having less precision, we decided to use <strong>an approximate method</strong>. The one that Robotoff uses is called HNSW (hierarchical navigable small world). You can take a look at <a rel="noreferrer noopener" href="https://www.pinecone.io/learn/vector-indexes/" target="_blank">this article</a> to understand better nearest neighbours search.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Using a HNSW ElasticSearch index, Robotoff is now able to look for the nearest neighbours of each embedding among more than 2.5M vectors with a huge precision (more than 90% of the 100 nearest neighbours returned are among the exact 100 true nearest neighbours) and a short search time of less than 100ms üëèüëèüëèüëè.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>You can use the following API to get the nearest neighbours of a logo: <a href="https://robotoff.openfoodfacts.org/api/v1/ann/search/[logo_id]?count=[count]">https://robotoff.openfoodfacts.org/api/v1/ann/search/[logo_id]?count=[count]</a></p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3><strong>üçØ A spoon of contributions: </strong>Where is it used?</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>No automatic logo categorization is yet implemented in Robotoff. Everything I explained before is made only for <a href="https://hunger.openfoodfacts.org/">Hunger Games</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>O que √© isso? It is <strong>an annotation platform </strong>developed by a contributor named Alexandre Fauquette which <strong>allows everyone to answer check predictions made by Robotoff and to categorise logos</strong>.&nbsp;</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><br>You can try it. A quick introduction/tutorial will welcome you and you will be able to annotate logos ! üòâ<br>A video tutorial of ‚ÄúHow to use Hunger Games ?‚Äù should be out soon‚Ä¶ ‚è≥ ‚è≥ ‚è≥ ‚è≥ ‚è≥ ‚è≥</p>
<!-- /wp:paragraph -->

<!-- wp:image {"align":"center","id":3433,"width":505,"height":633,"sizeSlug":"full","linkDestination":"custom"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="hunger.openfoodfacts.org"><img src="https://blog.openfoodfacts.org/wp-content/uploads/2023/02/Screenshot-2023-02-14-at-14.44.23.png" alt="" class="wp-image-3433" width="505" height="633"/></a><figcaption class="wp-element-caption">To play the Hunger Games: hunger.openfoodfacts.org</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p><strong>Annotating logos enhance Open Food Facts as it grows the amount of data we have on products and its quality.</strong> And thanks to the models and algorithms used in the background, you can be way more powerful and have a greater impact on people daily alimentation ü•∞.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Article by Gabriel</p>
<!-- /wp:paragraph -->

<!-- wp:image {"align":"left","id":3418,"width":167,"height":167,"sizeSlug":"full","linkDestination":"none"} -->
<figure class="wp-block-image alignleft size-full is-resized"><img src="https://blog.openfoodfacts.org/wp-content/uploads/2023/02/Gabriel.png" alt="" class="wp-image-3418" width="167" height="167"/></figure>
<!-- /wp:image -->
