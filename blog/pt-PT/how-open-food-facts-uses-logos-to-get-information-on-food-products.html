How Open Food Facts uses logos to get information on food products

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3><strong>üßÇA pinch of context:</strong> ‚Äúlogos‚Äù ?</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>O Open Food Facts tem cerca de <strong>3 milh√µes de produtos</strong>. A embalagem de cada produto √© concebida de modo a atrair o maior n√∫mero poss√≠vel de consumidores. Para o efeito, os produtores destacam as qualidades dos seus produtos com<strong> s√≠mbolos chamativos e expl√≠citos</strong>. Estes s√≠mbolos s√£o numerosos e servem para dar informa√ß√µes sobre a marca do produto, a sua qualidade, a sua composi√ß√£o, o modo como foi fabricado, em que recipiente deve ser reciclado, etc‚Ä¶&nbsp;</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Para uniformizar todos os s√≠mbolos e ajudar os consumidores a encontrar os produtos que lhes interessam, <strong>v√°rias institui√ß√µes criaram regras rigorosas para que os produtores possam marcar os seus produtos com s√≠mbolos espec√≠ficos, a que chamamos "log√≥tipos"</strong>. Esta √© uma grande oportunidade üî• para obter os dados sobre os produtos atrav√©s da dete√ß√£o destes log√≥tipos!</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><strong>Como √© que a Open Food Facts deve detet√°-los? Gra√ßas √† intera√ß√£o entre a tecnologia e os contribuidores, como sempre!</strong></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Rapha√´l Bournhonesque, um antigo colaborador do Open Food Facts que agora faz parte da equipa permanente e meu supervisor de est√°gio, desenvolveu no Robotoff* <strong>um sistema para extrair os log√≥tipos das imagens, convert√™-los em vectores e encontrar os vizinhos mais pr√≥ximos de cada vetor.</strong> O objetivo de encontrar os vizinhos dos log√≥tipos era <strong>permitir que os colaboradores "anotassem" (categorizassem manualmente) quantidades maci√ßas de log√≥tipos em simult√¢neo atrav√©s de uma plataforma, denominada <a rel="noreferrer noopener" href="https://hunger.openfoodfacts.org/" target="_blank">Hunger Games</a> </strong>üòâ.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>No entanto, os modelos e algoritmos utilizados na altura n√£o permitiam obter resultados eficientes o suficiente.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Em setembro de 2022, eu, enquanto estudante de engenharia, juntei-me √† equipa para um est√°gio de 6 meses dedicado aos log√≥tipos, e colaborei na refatora√ß√£o de todo este processo! &nbsp;</p>
<!-- /wp:paragraph -->

<!-- wp:table -->
<figure class="wp-block-table"><table><tbody><tr><td><strong>* O que √© o Robotoff ?</strong><br><a rel="noreferrer noopener" href="https://github.com/openfoodfacts/robotoff" target="_blank">Robotoff</a> √© um servi√ßo desenvolvido por colaboradores para ajudar no processamento de dados do Open Food Facts. A partir dos dados j√° dispon√≠veis na base de dados, o objetivo √© obter o m√°ximo de informa√ß√£o poss√≠vel sobre cada produto e adicion√°-los √† base de dados. Atualmente, as atualiza√ß√µes feitas pelo Robotoff prov√™m da an√°lise de imagens, atrav√©s do Reconhecimento √ìtico de Carateres ou de modelos de Vis√£o Computacional mais gerais. Algumas atualiza√ß√µes s√£o integradas automaticamente √† base de dados, mas outras precisam de valida√ß√£o manual por meio de perguntas ou do Hunger Games.<br><br><em><strong>Para saber mais sobre o Robotoff, veja <a rel="noreferrer noopener" href="https://github.com/openfoodfacts/robotoff#readme" target="_blank">aqui</a>!</strong></em> üëÄ</td></tr></tbody></table></figure>
<!-- /wp:table -->

<!-- wp:heading {"level":3} -->
<h3><strong>ü´ó Uma dica tecnol√≥gica: </strong>Como funciona exatamente o processamento de log√≥tipos?</h3>
<!-- /wp:heading -->

<!-- wp:heading {"level":4} -->
<h4><em>1Ô∏è‚É£ </em>Extrair log√≥tipos das imagens dos produtos:</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Os colaboradores do Open Food Facts ensaiaram um modelo de Aprendizagem Autom√°tica (Machine Learning) para reconhecer log√≥tipos em imagens. Usamos uma imagem como entrada do modelo e recebemos m√∫ltiplas caixas delimitadoras com as pontua√ß√µes e as categorias correspondentes. As categorias em que o modelo foi ensaiado foram "marca" e "r√≥tulo".</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Pode encontrar o c√≥digo onde o modelo √© ativado aqui: <a href="https://github.com/openfoodfacts/robotoff/blob/b209707cc062310b51f9886c87ee14be91527644/robotoff/workers/tasks/import_image.py#L325" target="_blank" rel="noreferrer noopener">Robotoff.import_image.py</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Pode experiment√°-lo utilizando a seguinte API :&nbsp;<a href="https://robotoff.openfoodfacts.net/api/v1/images/predict?image_url=[image_url]&amp;models=universal-logo-detector" target="_blank" rel="noreferrer noopener">https://robotoff.openfoodfacts.net/api/v1/images/predict?image_url=[image_url]&amp;models=universal-logo-detetor</a></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Com as caixas delimitadoras, √© poss√≠vel ver quais s√£o os log√≥tipos correspondentes com a API: <a href="https://robotoff.openfoodfacts.net/api/v1/images/crop?image_url=[image_url]&amp;y_min=[y_min]&amp;x_min=[x_min]&amp;y_max=[y_max]&amp;x_max=[x_max]" target="_blank" rel="noreferrer noopener">https://robotoff.openfoodfacts.net/api/v1/images/crop?image_url=[image_url]&amp;y_min=[y_min]&amp;x_min=[x_min]&amp;y_max=[y_max]&amp;x_max=[x_max]</a> onde as coordenadas est√£o na mesma ordem que as retornadas pelo modelo nas caixas delimitadoras.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Aqui est√° um exemplo do que acontece quando se utilizam estas APIs com a imagem seguinte:</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><a href="https://images.openfoodfacts.org/images/products/322/982/012/9488/front_fr.194.400.jpg" target="_blank" rel="noreferrer noopener">https://images.openfoodfacts.org/images/products/322/982/012/9488/front_fr.194.400.jpg</a></p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":3425,"width":806,"height":252,"sizeSlug":"large","linkDestination":"none"} -->
<figure class="wp-block-image size-large is-resized"><img src="https://blog.openfoodfacts.org/wp-content/uploads/2023/02/Screenshot-2023-02-14-at-14.34.51-1024x321.png" alt="" class="wp-image-3425" width="806" height="252"/></figure>
<!-- /wp:image -->

<!-- wp:heading {"level":4} -->
<h4><em>2Ô∏è‚É£ </em>Converter imagens de log√≥tipos em Vectores:</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><strong>Agora que podemos aceder aos log√≥tipos, precisamos de os vetorizar</strong>. Para isso, usamos um modelo pr√©-treinado pela OpenAI chamado <a href="https://huggingface.co/docs/transformers/model_doc/clip" target="_blank" rel="noreferrer noopener">CLIP</a>. Embora o modelo tenha sido inicialmente treinado para fazer corresponder imagens a texto, utilizamos apenas a parte de "vis√£o por computador" do modelo para obter a incorpora√ß√£o (=logos integrados num espa√ßo vetorial) calculada pelo CLIP para cada log√≥tipo.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>We thus have a logo image as input and a vector of dimension 512 as output. Quanto menor for a dist√¢ncia entre dois vetores, maior ser√° a semelhan√ßa entre os dois log√≥tipos correspondentes.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>A fun√ß√£o <a href="https://github.com/openfoodfacts/robotoff/blob/b209707cc062310b51f9886c87ee14be91527644/robotoff/workers/tasks/import_image.py#L398" target="_blank" rel="noreferrer noopener">save_logo_embeddings</a> no Robotoff aplica o modelo aos log√≥tipos e guarda os "embeddings" na base de dados postgresql do Robotoff.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Pode encontrar um c√≥digo mais expl√≠cito <a href="https://github.com/openfoodfacts/openfoodfacts-ai/blob/develop/logo-ann/generation/02_generate_embeddings.py#L108" target="_blank" rel="noreferrer noopener">aqui</a> para perceber como utilizamos o CLIP para fazer a incorpora√ß√£o de log√≥tipos.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4><em>3Ô∏è‚É£ </em>Encontre vizinhos mais pr√≥ximos:</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Para encontrar os vizinhos mais pr√≥ximos de um log√≥tipo, usamos um "√≠ndice" para armazenar as incorpora√ß√µes. Assim que este √≠ndice estiver criado, podemos utilizar o m√©todo <strong>"for√ßa bruta" üí™ que consiste em calcular a dist√¢ncia entre o log√≥tipo pesquisado e todos os outros log√≥tipos da base de dados e devolver os mais pr√≥ximos</strong>. √â o m√©todo mais exato, na medida em que nos d√° os "verdadeiros" vizinhos mais pr√≥ximos. No entanto, este m√©todo √© demasiado lento para ser aplicado. O tempo necess√°rio para extrair os vizinhos mais pr√≥ximos de cada log√≥tipo para um total de 2,5 milh√µes de log√≥tipos √© de cerca de 3s üò¥</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Como era necess√°rio melhorar o tempo de pesquisa e n√£o nos importava termos menos precis√£o, decidimos utilizar <strong>um m√©todo aproximado</strong>. A que √© utilizada pelo Robotoff chama-se HNSW (hierarchical navigable small world). Pode dar uma vista de olhos a <a rel="noreferrer noopener" href="https://www.pinecone.io/learn/vector-indexes/" target="_blank">este artigo</a> para compreender melhor a pesquisa dos vizinhos mais pr√≥ximos.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Utilizando um √≠ndice HNSW ElasticSearch, o Robotoff consegue agora procurar os vizinhos mais pr√≥ximos de cada incorpora√ß√£o entre mais de 2,5 milh√µes de vetores com grande precis√£o (mais de 90% dos 100 vizinhos mais pr√≥ximos devolvidos est√£o entre os 100 vizinhos reais mais pr√≥ximos) e um tempo de pesquisa curto, inferior a 100ms üëèüëèüëèüëè.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Pode utilizar a seguinte API para obter os vizinhos mais pr√≥ximos de um log√≥tipo: <a href="https://robotoff.openfoodfacts.org/api/v1/ann/search/[logo_id]?count=[count]">https://robotoff.openfoodfacts.org/api/v1/ann/search/[logo_id]?count=[count]</a></p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3><strong>üçØ Uma colher de contribui√ß√µes: </strong>Onde √© que ela √© usada?</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>A categoriza√ß√£o autom√°tica de log√≥tipos ainda n√£o est√° implementada no Robotoff. Tudo o que expliquei anteriormente foi feito apenas para <a href="https://hunger.openfoodfacts.org/">Hunger Games</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>O que √©? It is <strong>an annotation platform </strong>developed by a contributor named Alexandre Fauquette which <strong>allows everyone to answer check predictions made by Robotoff and to categorise logos</strong>.&nbsp;</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><br>Pode experiment√°-la. Uma r√°pida introdu√ß√£o/tutorial dar-lhe-√° as boas-vindas e poder√° fazer anota√ß√µes em log√≥tipos! üòâ<br>Um v√≠deo tutorial sobre "Como utilizar Hunger Games?" dever√° ser lan√ßado em breve‚Ä¶ ‚è≥</p>
<!-- /wp:paragraph -->

<!-- wp:image {"align":"center","id":3433,"width":505,"height":633,"sizeSlug":"full","linkDestination":"custom"} -->
<figure class="wp-block-image aligncenter size-full is-resized"><a href="hunger.openfoodfacts.org"><img src="https://blog.openfoodfacts.org/wp-content/uploads/2023/02/Screenshot-2023-02-14-at-14.44.23.png" alt="" class="wp-image-3433" width="505" height="633"/></a><figcaption class="wp-element-caption">Para jogar Hunger Games:: hunger.openfoodfacts.org</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p><strong>Annotating logos enhance Open Food Facts as it grows the amount of data we have on products and its quality.</strong> And thanks to the models and algorithms used in the background, you can be way more powerful and have a greater impact on people daily alimentation ü•∞.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Article by Gabriel</p>
<!-- /wp:paragraph -->

<!-- wp:image {"align":"left","id":3418,"width":167,"height":167,"sizeSlug":"full","linkDestination":"none"} -->
<figure class="wp-block-image alignleft size-full is-resized"><img src="https://blog.openfoodfacts.org/wp-content/uploads/2023/02/Gabriel.png" alt="" class="wp-image-3418" width="167" height="167"/></figure>
<!-- /wp:image -->
